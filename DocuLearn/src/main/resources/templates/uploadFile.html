<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Upload File</title>
    <th:block th:replace="base :: styles"></th:block>
    <th:block th:replace="stepbar :: styles"></th:block>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .upload-box {
            border: 2px dashed #0d6efd; /* xanh đậm */
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            background-color: #e7f1ff; /* xanh nhạt */
            transition: background-color 0.3s, border-color 0.3s;
        }
        .upload-box.dragover {
            background-color: #d0e4ff;
            border-color: #0a58ca;
        }
        .custom-progress { display: none; } /* Ẩn progress ban đầu */
    </style>
</head>

<body data-course-id="[[${courseId}]]">
<main class="container py-5">
    <div th:replace="stepbar :: stepbar(1)"></div>
    <div class="text-center mb-4"><h2>Upload Document</h2></div>

    <div id="dropZone" class="upload-box mb-4">
        <p><strong>Kéo & Thả file vào đây</strong></p>
        <p>hoặc</p>

        <form id="uploadForm" th:action="@{/course/{id}/add-file(id=${courseId})}" method="post" enctype="multipart/form-data">
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" id="courseId"  th:value="${courseId}"/>

            <input id="fileInput" class="form-control" type="file" name="file" accept=".pdf,.doc,.docx" />
            <button id="uploadBtn" class="btn btn-primary mt-3" type="submit" disabled
                    th:text="'Upload '">
            </button>
        </form>

        <p class="text-muted mt-3">Supported files: pdf, doc, docx</p>
    </div>

    <!-- Progress -->
    <div class="mb-3">
        <div id="fileName" class="mb-1 text-muted"></div>
        <div class="custom-progress progress">
            <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%">0%</div>
        </div>
    </div>

    <div id="uploadResult" class="mt-3"></div>

    <!-- Naviagate đến page tt -->
    <div class="d-flex flex-row-reverse">
        <button id="next" class="btn btn-primary" type="button">
            <a class="nav-link" th:href="@{'/course/' + ${courseId} + '/upload-file/details'}">Next</a>
        </button>
    </div>

</main>
<div th:replace="base :: footer"></div>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const progress = document.querySelector('.custom-progress');
        const progressBar = document.getElementById('uploadProgress');
        const fileNameDiv = document.getElementById('fileName');
        const resultDiv = document.getElementById('uploadResult');
        const dropZone = document.getElementById('dropZone');
        const courseId = document.getElementById('courseId').value;
        const nextBtn = document.getElementById('next');

        const allowedExt = ['pdf','doc','docx'];
        const uploadUrl = `/doculearn/course/${courseId}/add-file`;

        if (nextBtn) nextBtn.style.display = 'none';
        // Kéo & thả file
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files; // gán file cho input
                fileInput.dispatchEvent(new Event('change')); // trigger check
            }
        });

        // Kiểm tra file hợp lệ
        fileInput.addEventListener('change', function () {
            resultDiv.innerHTML = '';
            progress.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.classList.remove('bg-success','bg-danger');
            progressBar.classList.add('progress-bar-striped','progress-bar-animated');

            if (!fileInput.files || fileInput.files.length === 0) {
                if (uploadBtn) uploadBtn.disabled = true;
                fileNameDiv.textContent = '';
                return;
            }

            const f = fileInput.files[0];
            fileNameDiv.textContent = `${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB)`;
            const ext = f.name.split('.').pop().toLowerCase();

            if (!allowedExt.includes(ext)) {
                resultDiv.innerHTML = `<div class="alert alert-warning">Chỉ cho phép file: .pdf, .doc, .docx</div>`;
                uploadBtn.disabled = true;
            } else {
                uploadBtn.disabled = false;
            }
        });

        // Submit form
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!fileInput.files.length) {
                alert('Vui lòng chọn file trước khi upload.');
                return;
            }

            const f = fileInput.files[0];
            const ext = f.name.split('.').pop().toLowerCase();
            if (!allowedExt.includes(ext)) {
                resultDiv.innerHTML = `<div class="alert alert-warning">Chỉ cho phép file: .pdf, .doc, .docx</div>`;
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            const fd = new FormData();
            fd.append('file', f);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', uploadUrl, true);

            progress.style.display = 'block'; // hiện progress khi upload bắt đầu

            xhr.upload.addEventListener('progress', function (ev) {
                if (ev.lengthComputable) {
                    const percent = Math.round((ev.loaded / ev.total) * 100);
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                }
            });

            xhr.onload = function () {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
                if (xhr.status >= 200 && xhr.status < 300) {
                    progressBar.style.width = '100%';
                    progressBar.textContent = 'Hoàn tất';
                    progressBar.classList.add('bg-success');
                    resultDiv.innerHTML = `<div class="alert alert-success">Upload thành công!</div>`;

                    if (nextBtn) nextBtn.style.display = '';
                } else {
                    progressBar.classList.add('bg-danger');
                    resultDiv.innerHTML = `<div class="alert alert-danger">Upload thất bại</div>`;

                }
            };

            xhr.onerror = function () {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
                progressBar.classList.add('bg-danger');
                resultDiv.innerHTML = `<div class="alert alert-danger">Lỗi kết nối khi upload!</div>`;
            };

            xhr.send(fd);
        });
    });
</script>
</body>
</html>
